
<table class="table table-dark table-sm mb-2">
    <tr>
        <th>Submitter</th>
        <td>
            <span title="#{{ request.user.id }}">{{ request.user.name }}</span>
            {% if request.user.name is empty %}
                #{{ request.user.id }}
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Submitted</th>
        <td>{{ request.created|date('Y-m-d H:i e') }}</td>
    </tr>
    <tr>
        <th>Pilot</th>
        <td>
            <a href="https://evewho.com/character/{{ request.character.id }}" class="srp-external-link"
               title="EveWho" target="_blank" rel="noopener noreferrer">{{ request.character.name }}</a>,
            {% if request.corporationId %}
                <a href="https://evewho.com/corporation/{{ request.corporationId }}" class="srp-external-link"
                   title="EveWho" target="_blank" rel="noopener noreferrer">{{ request.corporationName }}</a>,
            {% else %}
                {{ request.corporationName }},
            {% endif %}
            {% if request.allianceId %}
                <a href="https://evewho.com/alliance/{{ request.allianceId }}" class="srp-external-link"
                   title="EveWho" target="_blank" rel="noopener noreferrer">{{ request.allianceName }}</a>
            {% elseif request.allianceName %}
                {{ request.allianceName }}
            {% else %}
                no alliance
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Date and time</th>
        <td>{{ request.killTime|date('Y-m-d H:i e') }}</td>
    </tr>
    <tr>
        <th>Solar system</th>
        <td>
            <a href="https://evemaps.dotlan.net/system/{{ request.solarSystem }}" class="srp-external-link"
               title="Dotlan" target="_blank" rel="noopener noreferrer">{{ request.solarSystem }}</a>
        </td>
    </tr>
    <tr>
        <th>External URLs</th>
        <td>
            {% if request.killboardUrl %}
                <a href="{{ request.killboardUrl }}" class="srp-external-link"
                   target="_blank" rel="noopener noreferrer">zKillboard</a>,
            {% endif %}
            {% if request.esiLink %}
                <a href="{{ request.esiLink }}" class="srp-external-link"
                   target="_blank" rel="noopener noreferrer">ESI</a>
            {% endif %}
        </td>
    </tr>
</table>

<h5 class="mb-1 mt-3">Details</h5>
<div class="srp-bg-dark-2 small p-1">{{ request.details|nl2br }}</div>

<div class="row mt-3">
    <div class="col">
        <form action="/request/{{ request.id }}/update" method="post">
            <table class="table table-dark table-sm">
                <tr>
                    <th><label for="editDivision">Division</label></th>
                    <td>
                        {% if mayChangeDivision(request) %}
                            <select class="form-select form-select-sm" name="division" id="editDivision">
                                <option disabled {{ request.division ? '' : 'selected' }} ></option>
                                {% for division in getDivisionsWithEditPermission() %}
                                    <option value="{{ division.id }}"
                                            {{ division.id == request.division.id ? 'selected' : '' }}>
                                        {{ division.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            {{ request.division.name }}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th><label for="editStatus">Status</label></th>
                    <td>
                        {% if mayChangeStatus(request) %}
                            {% set changeableStatus = getAllowedNewStatuses(request) %}
                            <select class="form-select form-select-sm" name="status" id="editStatus">
                                {% for status in data.statuses %}
                                    <option value="{{ status }}"
                                            {{ status in changeableStatus ? '' : 'disabled' }}
                                            {{ status == request.status ? 'selected' : '' }}>
                                        {{ status }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            {{ request.status }}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th><label for="editPayout">Base payout</label></th>
                    <td>
                        {% if mayChangePayout(request) %}
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" name="payout" id="editPayout"
                                       value="{{ request.basePayout ? request.basePayout|number_format : '' }}">
                                <span class="input-group-text text-light bg-dark">ISK</span>
                            </div>
                        {% elseif request.basePayout %}
                            {{ request.basePayout|number_format }} ISK
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Payout</th>
                    <td>{{ request.payout ? request.payout|number_format + ' ISK' : '' }}</td>
                </tr>
            </table>

            {% if mayAddComment(request) %}
                <label for="addComment" class="form-label">Comment</label>
                <textarea class="form-control" name="comment" id="addComment" rows="3"></textarea>
            {% endif %}

            {% if maySave(request) %}
                <button type="submit" class="mt-3 btn btn-primary float-end" id="requestFormSubmit">
                    {{ request.status == constant('EveSrp\\Type::INCOMPLETE') ? 'Submit' : 'Save' }}
                </button>
            {% endif %}
        </form>
    </div>
    <div class="col data-modifier">
        <h6 class="mt-2">Modifier</h6>
        {% for modifier in request.modifiers %}
            <div class="table-dark border-bottom pb-2 mb-2">
                <span class=" {{ modifier.voidedTime ? 'text-decoration-line-through' : '' }}">
                    {{ modifier.modValue|number_format }}{%
                        if modifier.modType == 'relative' %}%{% else %} ISK{% endif
                    %}
                    {% if modifier.modValue > 0 %} bonus {% else %} penalty{% endif %}
                </span>
                <br>
                <small>
                    <span title="Time zone: {{ modifier.created|date('e') }}">
                        {{ modifier.created|date('Y-m-d H:i') }}</span>,
                    <span title="#{{ modifier.user.id }}">{{ modifier.user.name }}</span>
                    {% if modifier.user.name is empty %}
                        #{{ modifier.user.id }}
                    {% endif %}
                    <br>
                    {% if modifier.note %}
                        <div class="srp-bg-dark-2 p-1">{{ modifier.note|nl2br }}</div>
                    {% endif %}
                    {% if modifier.voidedTime %}
                        Voided:
                        <span title="Time zone: {{ modifier.voidedTime|date('e') }}">
                            {{ modifier.voidedTime|date('Y-m-d H:i') }}</span>,
                        <span title="#{{ modifier.voidedUser.id }}">{{ modifier.voidedUser.name }}</span>
                        {% if modifier.voidedUser.name is empty %}#{{ modifier.voidedUser.id }}{% endif %}
                    {% endif %}
                </small>
            </div>
        {% endfor %}
    </div>
</div>

<h5 class="mt-2">Changes</h5>
<table class="table table-dark table-sm table-borderless small data-changes">
    {% for action in request.actions %}
        <tr class="{{ action.note ? '' : 'border-bottom' }}">
            <td>{{ action.created|date('Y-m-d H:i e') }}</td>
            <td>{{ action.category }}</td>
            <td>
                <span title="#{{ action.user.id }}">{{ action.user.name }}</span>
                {% if action.user.name is empty %}
                    #{{ action.user.id }}
                {% endif %}
            </td>
        </tr>
        {% if action.note %}
            <tr class="border-bottom">
                <td colspan="3"><div class="srp-bg-dark-2 p-1">{{ action.note|nl2br }}</div></td>
            </tr>
        {% endif %}
    {% endfor %}
</table>
